on:
  push:
  workflow_dispatch:

name: Build and Deploy
jobs:
  build-infrastructure:
    name: Build Infrastructure
    uses: ./.github/workflows/build-infrastructure.yaml
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}
      REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
      REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
  
  build-and-push-container:
    name: Build and Push Container
    uses: ./.github/workflows/build-and-push-container.yaml
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      CONTAINER_REGISTRY_LOGIN_SERVER: ${{ secrets.REGISTRY_LOGIN_SERVER }}


  deploy-infrastructure-development:
    name: Deploy Infrastructure to Development
    uses: ./.github/workflows/deploy-infrastructure.yaml
    needs: build-infrastructure
    with:
      environment: development
      subscriptionId: ${{ vars.SUBSCRIPTION_ID }}
      resourceGroupName: ${{ vars.RESOURCE_GROUP_NAME }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
